name: Validate Routine Templates

on:
  pull_request:
    paths:
      - 'examples/*.json'
      - 'routine-schema.json'
  push:
    paths:
      - 'examples/*.json'
      - 'routine-schema.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest
    name: Validate JSON Schema
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install JSON schema validator
      run: npm install -g ajv-cli
      
    - name: Validate routine templates
      run: |
        echo "ğŸ” Validating routine templates against schema..."
        
        # Check if schema file exists
        if [ ! -f "routine-schema.json" ]; then
          echo "âŒ Schema file not found!"
          exit 1
        fi
        
        # Validate each routine file
        for file in examples/*.json; do
          if [ -f "$file" ]; then
            echo "ğŸ“‹ Validating $file..."
            if ajv validate -s routine-schema.json -d "$file"; then
              echo "âœ… $file is valid"
            else
              echo "âŒ $file has validation errors"
              exit 1
            fi
          fi
        done
        
        echo "ğŸ‰ All routine templates are valid!"
        
    - name: Check for required fields
      run: |
        echo "ğŸ” Checking for required fields in routines..."
        
        for file in examples/*.json; do
          if [ -f "$file" ]; then
            echo "ğŸ“‹ Checking $file..."
            
            # Check for required fields using jq
            if ! jq -e '.title' "$file" > /dev/null; then
              echo "âŒ $file missing 'title' field"
              exit 1
            fi
            
            if ! jq -e '.description' "$file" > /dev/null; then
              echo "âŒ $file missing 'description' field"
              exit 1
            fi
            
            if ! jq -e '.phases' "$file" > /dev/null; then
              echo "âŒ $file missing 'phases' field"
              exit 1
            fi
            
            echo "âœ… $file has all required fields"
          fi
        done
        
        echo "ğŸ‰ All routines have required fields!"
        
    - name: Check for neurodivergent-friendly language
      run: |
        echo "ğŸ§  Checking for neurodivergent-friendly language..."
        
        # Look for potentially problematic terms
        PROBLEMATIC_TERMS=("normal" "should" "must" "failure" "lazy" "discipline")
        
        for file in examples/*.json; do
          if [ -f "$file" ]; then
            echo "ğŸ“‹ Checking language in $file..."
            
            for term in "${PROBLEMATIC_TERMS[@]}"; do
              if grep -i "$term" "$file" > /dev/null; then
                echo "âš ï¸  Found potentially problematic term '$term' in $file"
                echo "   Consider using more neurodivergent-friendly language"
              fi
            done
          fi
        done
        
        echo "âœ… Language check complete!"
        
    - name: Summary
      run: |
        echo "ğŸ‰ Routine validation complete!"
        echo "ğŸ“Š Summary:"
        echo "  - JSON schema validation: âœ…"
        echo "  - Required fields check: âœ…"
        echo "  - Language review: âœ…"
        echo ""
        echo "ğŸ§  Thank you for contributing to our neurodivergent community!" 